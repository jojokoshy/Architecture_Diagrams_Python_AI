
%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart TB

%% Shared styles
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

%% Main Flow

A[Timer Trigger every 5 minutes]:::step --> B[Get Start DateTime from JourneyAlert table]:::step
B --> C[Call NetReveal TrueHit API for Alerts since Start DateTime]:::step

%% loop entry after C
C --> AlertsLoopStart((Loop: Alerts Array)):::loop

subgraph AlertsLoop [Loop through Alerts]
	direction TB
	AlertsLoopStart --> D{Alert Status?}:::decision
	D -->|Confirmed/Disapproved| E[Save the Alert Details to Database]:::step
	D -->|Reopened| AlertsLoopStart

	E --> F1[Read from all unprocessed alerts where ScreeningAlertDetails rowcount => ScreeningAlert rowcount by BatchId]:::step
	
	F1 --> J1[Group all Alerts from ScreeningAlertDetails by BatchId ]:::step

	J1 --> BatchLoopStart((Loop: For every BatchId)):::loop

	subgraph BatchLoop [Loop: For every Unique BatchId  ]
		direction TB
		BatchLoopStart --> J2[ Submit to Receptor API all Alerts with same BatchId with Flag indicating Screening Type]:::step
		J2 --> BatchLoopStart
	end

	BatchLoop --> AlertsLoopStart
end

%% Legend
subgraph Legend [Legend]
	direction LR
	L2[Decision]:::decision
	L3[Loop]:::loop	
end

AlertsLoop --> BottomAnchor(( ))
BottomAnchor --> N[Change flag of all AlertsIds that were successfully send to FenX]:::step
N --> O[Update JourneyAlert table: Job Success]:::footer
class BottomAnchor footer
