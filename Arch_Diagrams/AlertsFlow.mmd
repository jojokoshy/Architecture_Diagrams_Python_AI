
%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart TB

%% Shared styles
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

%% Main Flow

A[Timer Trigger every 5 minutes]:::step --> B[Get Start DateTime from JourneyAlert table]:::step
B --> C[Call NetReveal TrueHit API for Alerts since Start DateTime]:::step

%% loop entry after C
C --> AlertsLoopStart((Loop: Alerts Array)):::loop

subgraph AlertsLoop [Loop through Alerts]
	direction TB
	AlertsLoopStart --> D{Alert Status?}:::decision
	D -->|Confirmed/Disapproved| E[Query FenX for Journey Info]:::step
	D -->|Reopened| AlertsLoopStart

	E --> F1{Journey Open?}:::decision
	F1 -->|Yes| F2{At Screening Stage?}:::decision
	F1 -->|No| J1[Initiate new screening journey]:::step
	F2 -->|Yes| G[Update Journey via Receptor API]:::step
	G --> AlertsLoopStart
	F2 -->|No| I[Save Alert to PendingJourneyAlerts]:::step

	J1 --> J2[Update Alert and continue]:::step
	J2 --> AlertsLoopStart
	I --> AlertsLoopStart
end

%% Legend
subgraph Legend [Legend]
	direction LR
	L2[Decision]:::decision
	L3[Loop]:::loop	
end

AlertsLoop --> BottomAnchor(( ))
BottomAnchor --> O[Update JourneyAlert table: Job Success]:::footer
class BottomAnchor footer
