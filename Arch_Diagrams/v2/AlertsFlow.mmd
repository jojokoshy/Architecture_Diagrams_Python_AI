
%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart LR

%% Shared styles
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;
%% Comments / Legend
subgraph Comments [Comments / Legend]
  direction LR
  style Comments fill:#f9fafb,stroke:#e5e7eb,color:#0f172a,stroke-width:1px;
  note1["To add comments and legend here"]:::footer
end

%% Main Flow
subgraph MainFlow ["Main Flow"]
  direction TB
	A["Timer Trigger every X minutes"]:::step --> B["Get {startDatetime} from JourneyAlertJob table. Last successful run time"]:::step
	B --> C["Call NetReveal TrueHit API for Alerts since {startDatetime}, : Returns Array[{alerts}]"]:::step
	SaveToDB["Store All Retrieved Alerts into JourneyAlertDetails Database Table"]:::step
	C --> SaveToDB
	%% This logic can happen in a Single Stored Procedure call - Shown as multiple steps for Clarity
	subgraph CheckAlertsFlow ["All Checks and Updates in DB "]
		direction TB
		RetriveClosedAlerts["Retrieve Only Closed Alerts from JourneyAlertDetails Database Table where {AlertStatus = 'Closed'} and {ProcessingFlag = Null}"]:::step
		SaveToDB --> RetriveClosedAlerts
		CheckAllAlertsForBatch["Check Alert Hit Count grouped by BatchId == Alert Details count Grouped by BatchID"]:::step
		RetriveClosedAlerts --> CheckAllAlertsForBatch

		UpdateAlerts["Update JourneyAlertDetails Table set {ProcessingFlag=Processing} for Retrieved Closed Alerts by BatchId"]:::step
		CheckAllAlertsForBatch --> UpdateAlerts
	end
	%% loop entry after C
	UpdateAlerts --> AlertsLoopStart(("Loop: Array - Only Closed {alerts} and All Alerts For a BatchId")):::loop


	subgraph AlertsLoop ["Loop: Array - Only Closed {alerts} and All Alerts For a BatchId"]
		direction LR
		AlertsLoopStart --> E["Query FenX for Journey Info from FenX - Using SuperGraph"]:::step

		E --> F1{"Journey Open?"}:::decision
		F1 -->|Yes| F2{"At Screening Stage?"}:::decision
		F2 -->|Yes| A1:::step
		F2 -->|No| I
		F1 -->| <b>No</b> | A0["Mark the Journey as Ongoing Screening"]:::step
		A0 --> A1
		A1 --> N1(("Loop: Pending Alerts Grouped by BatchId")):::loop
		%%A2 --> LoopStart((Loop: Pending Alerts)):::loop
		N1["Update Journey by calling FenX Receptor API Grouped By BatchId"]:::step
		N1 --> N2["Update {ProcessingFlag=Processed} and continue"]:::step
		
		N2 -->DoneProcessingAlert["Pick Next Batch Alert"]:::step
		DoneProcessingAlert --> AlertsLoopStart
		I["Set {ProcessingFlag = Null} in JourneyAlertDetails Table  "]:::step
		I --> AlertsLoopStart
	end
	AlertsLoop --> BottomAnchor((" "))
	BottomAnchor --> O["Update the Datetime of Last Successful Run in JourneyAlertJob Table"]:::footer
	class BottomAnchor footer
end
 


style MainFlow stroke-dasharray: 5 5

%% Decision between main and error blocks
IfError{"if error?"}:::decision

%% Error handling block to the right
subgraph ErrorHandler ["Error handling"]
  direction TB
  EH1["Log Error to Error table"]:::step
  EH2["Set {ProcessingFlag} = Null for BatchIds Not Processed in JourneyAlertDetails Table"]:::step
  EH3["Call Receptor API with Error details"]:::step
  
  EH1 --> EH2 --> EH3
end

style ErrorHandler fill:#ffe6e6,stroke:#ff0000,stroke-dasharray: 5 5

%% Connections: only between blocks (not individual nodes)
MainFlow -.-> IfError
IfError -.-> ErrorHandler
Comments ~~~MainFlow