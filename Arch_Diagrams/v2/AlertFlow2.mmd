%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart TB
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

%% Pending Alerts Flow
A1[Timer Trigger]:::step --> A2[Query PendingJourneyAlerts DB - Open Alerts Only]:::step
A2 --> A3[Check Alert Hit Count grouped by BatchId == Alert Details count Grouped by BatchID]:::step
A3 -->AlertCheckCondition{If Hit Count matches Alert Details Count by BatchId}:::decision
AlertCheckCondition -->|Yes| A4[Get All BatchIds , JourneyId that fulfill condition]:::step 
A4 --> LoopStart((Loop: Pending Alerts Grouped by BatchId)):::loop
%%A2 --> LoopStart((Loop: Pending Alerts)):::loop

subgraph PendingLoop [Pending Alerts Grouped by BatchId]
	direction TB
	LoopStart --> E2[Query FenX for Journey Info]:::step
	E2 --> M{FenX Journey Open?}:::decision
	M -->|No| N0[Query Database to Get Alerts by JourneyId, BatchId]:::step
	M -->|Yes| LoopStart
	N0 --> N1[Update Journey by calling FenX Receptor API Grouped By BatchId]:::step
	N1 --> N2[Update Alert and continue]:::step
	N2 --> N3[Mark Pending Alert Closed in DB]:::step
	N3 --> LoopStart
end