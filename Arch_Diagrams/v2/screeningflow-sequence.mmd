%%{init: {"theme":"default","themeVariables": {"fontSize":"12"}}}%%
sequenceDiagram
  %% Participants left-to-right for readability
  participant Client
  participant iHubIn as "iHub API Mgmt (FenX)"
  participant FenX as "FenX (Source API / SuperGraph)"
  participant CLMAdaptor as "CLM-Adaptor"
  participant KeyVault
  participant DB as "Database"
  participant iHubOut as "iHub API Mgmt (NetReveal)"
  participant NetReveal

  %% Initial request
  Client->>+CLMAdaptor: HTTP POST with JourneyID, EntityID, Related Entities (encrypted JSON)

  %% Decrypt payload (must happen before validation)
  CLMAdaptor->>+KeyVault: Request decryption key
  KeyVault-->>CLMAdaptor: Return key
  CLMAdaptor->>+CLMAdaptor: Decrypt payload using KeyVault key

  %% Validate request schema
  CLMAdaptor->>+CLMAdaptor: Validate request schema for required fields (JourneyID, EntityID, Related Entities)
  alt Schema Invalid
    CLMAdaptor-->>Client: HTTP 400 Bad Request with validation errors
    %% End processing on validation error
  else Schema Valid
    CLMAdaptor-->>Client: HTTP 200 OK (immediate response)

    %% Store request
    CLMAdaptor->>+DB: Store Request payload
    DB-->>CLMAdaptor: Stored
  end
  
  %% %% Call FenX SuperGraph API
  %% Note over CLMAdaptor: Create SuperGraph using GraphQL with RequestId, JourneyId and EntityId
  %% CLMAdaptor->>+iHubIn: Call SuperGraph API 
  %% iHubIn->>+FenX: Forward SuperGraph request
  %% FenX-->>-iHubIn: Return {allEntities} 
  %% iHubIn-->>-CLMAdaptor: Return {allEntities} 
  %% CLMAdaptor->>+DB: Save SuperGraph Request / Response
  %% DB-->>-CLMAdaptor: Saved
  
  %% Call FenX Association Query API
    Note over CLMAdaptor: Identify Deleted Entities from SuperGraph
  CLMAdaptor->>+iHubIn: Call Association API /api/association/root/{EntityId}/journey/{JourneyId}/proposedChanges/hierarchy 
  iHubIn->>+FenX: Forward Association Query request
  FenX-->>-iHubIn: Return {deletedEntities} 
  iHubIn-->>-CLMAdaptor: Return {deletedEntities} 
  CLMAdaptor->>+DB: Save FenX Association Request / Response
  DB-->>-CLMAdaptor: Saved
  
  %% Loop through all entities
  loop For Each Entity in {allEntities}
    
    alt Current Entity is in {deletedEntities}
      Note over CLMAdaptor: Entity marked for deletion - query associations
      CLMAdaptor->>+iHubIn: Call Association API /api/association/root/{entityId}   
      iHubIn->>+FenX: Forward Association Query for entity
      FenX-->>-iHubIn: Return Related EntityIDs 
      iHubIn-->>-CLMAdaptor: Return Related EntityIDs 
      CLMAdaptor->>+DB: Save Entity Association Request / Response
      DB-->>-CLMAdaptor: Saved
      
      alt Related Entities Array Count >= 1
        Note over CLMAdaptor: Mark Entity as Active
            CLMAdaptor->>+CLMAdaptor: Mark as Active
      else Empty Related Entities
        Note over CLMAdaptor: Mark Entity as InActive
        CLMAdaptor->>+CLMAdaptor: Mark as InActive
      end
    else Current Entity is not deleted
      Note over CLMAdaptor: Normal entity processing
    end
    
    %% Get OrgUnit mapping
    CLMAdaptor->>+DB: Get OrgUnit from Azure SQL DB - Branch and Department mapping
    DB-->>CLMAdaptor: Return OrgUnit mapping
    
    %% Call FenX API to get Full Entity Details
    CLMAdaptor->>+iHubIn: Call FenX API to get Full Entity Details for current {entityId}
    iHubIn->>+FenX: Forward Entity Details request
    FenX-->>-iHubIn: Return Full Entity Details  
    iHubIn-->>-CLMAdaptor: Return Full Entity Details  
    CLMAdaptor->>+DB: Save Full Entity Details with OrgUnit Mapping and Active/Inactive status
    DB-->>-CLMAdaptor: Saved
    
    %% Prepare to call NetReveal - Convert JSON to XML
    Note over CLMAdaptor: Convert JSON to XML using XSLT Transformation for NetReveal Screening API
    CLMAdaptor->>+CLMAdaptor: Convert JSON to XML using XSLT Transformation
    
    %% Call NetReveal Screening API
    CLMAdaptor->>+iHubOut: Call NetReveal Screening API (XML)
    iHubOut->>+NetReveal: Forward Screening request (XML)
    NetReveal-->>iHubOut: Return AlertId (XML)
    iHubOut-->>CLMAdaptor: Return AlertId (XML)
    
    %% Save NetReveal response
    CLMAdaptor->>+DB: Save NetReveal AlertId against entity
    DB-->>CLMAdaptor: Saved
    
  end
  
    Note over CLMAdaptor: End process - No response sent back to FenX
  alt Error Occurs
      CLMAdaptor->>+DB: Log Error to Error table
      DB-->>CLMAdaptor: Logged
      CLMAdaptor->>+iHubIn: Call Receptor API with Error details
      iHubIn->>+FenX: Forward error to Receptor API
      FenX-->>iHubIn: Acknowledged
      iHubIn-->>CLMAdaptor: Error reported
  end