
%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart LR

%% Shared styles
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;
%% Comments / Legend
subgraph Comments [Comments / Legend]
  direction LR
  style Comments fill:#f9fafb,stroke:#e5e7eb,color:#0f172a,stroke-width:1px;
  note1["This flow is for processing journey alerts by a Timer Trigger which will batch and send Closed alerts to FenX Receptor API where the journey is Open and at Screening Stage"]:::footer
end

%% Main Flow
subgraph MainFlow ["Main Flow"]
  direction TB
	A["Timer Trigger every X minutes"]:::step --> B["Get {CompletedOn} from JourneyAlertJob where {AlertJobType='NetRevealAlerts'} table for last successful run. "]:::step
	B --> C["Call NetReveal TrueHit API for Alerts since {CompletedOn} as the startTime for retrieving Alerts, : Returns Array[{alerts}]"]:::step
	C --> InsertIntoJobAlertJob["Insert a new record into JourneyAlertJob Table Current Datetime as {StartedOn}, {BatchProcessingStatus=Processing} and {AlertJobType='NetRevealAlerts'} and get {JourneyAlertJobId} to be used later when each BatchId completes"]:::step
	InsertIntoJobAlertJob --> SaveToDB["Store All Retrieved Alerts into ScreeningHitDetails Database Table"]:::step

	%% This logic can happen in a Single Stored Procedure call - Shown as multiple steps for Clarity
	subgraph CheckAlertsFlow ["All Checks and Updates in DB "]
		direction TB
		RetriveClosedAlerts["Retrieve Only Closed Alerts from ScreeningHitDetails Database Table where {AlertStatus = 'Closed'} and {AlertProcessingStatus = Null}"]:::step
		SaveToDB --> RetriveClosedAlerts
		CheckAllAlertsForBatch["Get all Alert BatchId where Alert Hit Count grouped by BatchId (from ScreeningHitDetails Table) â‰¥ Alert Details count Grouped by BatchID (from ScreeningHit Table)"]:::step
		RetriveClosedAlerts --> CheckAllAlertsForBatch

		UpdateAlerts["Update ScreeningHitDetails Table set {AlertProcessingStatus=Processing} for Retrieved Closed Alerts by BatchId for the BatchIds that meet above condition"]:::step
		CheckAllAlertsForBatch --> UpdateAlerts
	end
	%% loop entry after C
	UpdateAlerts --> AlertsLoopStart(("Loop: Array - Only Closed {alerts} and All Alerts For a BatchId")):::loop


	subgraph AlertsLoop ["Loop: Array - Only Closed {alerts} and All Alerts For a BatchId"]
		direction LR
		AlertsLoopStart --> E["Query FenX for Journey Info from FenX - Using SuperGraph"]:::step

		E --> F1{"Journey Open?"}:::decision
		F1 -->|Yes| F2{"At Screening Stage?"}:::decision
		F2 -->|Yes| A1:::step
		F2 -->|No| I
		F1 -->| <b>No</b> | A0["Mark the Journey as Ongoing Screening"]:::step
		A0 --> A1
		A1 --> N1(("Loop: Pending Alerts Grouped by BatchId")):::loop
		%%A2 --> LoopStart((Loop: Pending Alerts)):::loop
		N1["Update Journey by calling FenX Receptor API Grouped By BatchId "]:::step
		N1 --> UpdateScreeningHitDetails["Update {AlertProcessingStatus=Processed} against {BatchId} to ScreeningHitDetails Table "]:::step
		UpdateScreeningHitDetails --> JourneyAlertJobRunDetails[" Insert into JourneyAlertJobRunDetails ({BatchId} , {BatchProcessingStatus}, {JourneyAlertJobId}) "]:::step
		
		JourneyAlertJobRunDetails -->DoneProcessingAlert["Pick Next Batch Alert"]:::step
		DoneProcessingAlert --> AlertsLoopStart
		I["Set {AlertProcessingStatus = Null} in ScreeningHitDetails Table  "]:::step
		I --> AlertsLoopStart
	end
	AlertsLoop --> BottomAnchor((" "))
	BottomAnchor --> O["Update the Datetime of Last Successful Run in JourneyAlertJob Table"]:::footer
	class BottomAnchor footer
end
 


style MainFlow stroke-dasharray: 5 5

%% Decision between main and error blocks
IfError{"if error?"}:::decision

%% Error handling block to the right
subgraph ErrorHandler ["Error handling"]
  direction TB
  EH1["Log Error to Error table"]:::step
  EH2["Set {AlertProcessingStatus} = Null for BatchIds Not Processed in ScreeningHitDetails Table"]:::step
  EH3["Call Receptor API with Error details"]:::step
  
  EH1 --> EH2 --> EH3
end

style ErrorHandler fill:#ffe6e6,stroke:#ff0000,stroke-dasharray: 5 5

%% Connections: only between blocks (not individual nodes)
MainFlow -.-> IfError
IfError -.-> ErrorHandler
Comments ~~~MainFlow