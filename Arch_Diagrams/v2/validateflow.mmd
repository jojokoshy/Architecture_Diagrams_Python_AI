%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart LR

%% Shared styles (matching AlertsFlow)
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;
subgraph Comments [Comments / Legend]
  direction LR
  style Comments fill:#f9fafb,stroke:#e5e7eb,color:#0f172a,stroke-width:1px;
  note1["Note: This flow is triggered by Screening Journey Adaptor Calls from FenX via Hub API Gateway. The flow is very similar to Cancel flow except that it uses <b>Current / Draft Entity Data</b> instead of <b>Verified Entities</b> in Cancel Journey.
  The idea is to build re-usable Durable Activity Functions which will be orchestrated using different Orchestration Functions based on the business flow ( cancel flow, screening flow , approval flow etc)"]:::footer
end
subgraph MainFlow [Main Flow]
  direction TB
  subgraph ClientFlow[Client Interaction]
    A["Client clicks 'Validate Task' on Main Screening Flow"]:::step
  end

  A --> B["POST payload to iHub API Gateway (includes JourneyId only)"]:::step
  B --> D["Respond 200 OK to client immediately"]:::step
  D --> F["Store Request payload in database"]:::step
  F --> Gcall["Calls FenX API SuperGraph and Get Entities involved including RP {allEntities}. Will just get the Entities involved, no other details required as Screening is already done."]:::step
  Gcall --> H["FenX (SuperGraph) returns EntityIDs & RelatedParties"]:::step

  subgraph EntityLoop["Per-Entity Processing {allEntities}"]
    direction TB
    I["Process each EntityID / RelatedParty"]:::loop
    I --> J["Convert JSON -> XML locally for the entity payload"]:::step
    J --> K["Call NetReveal API (via iHubOut) using CustomerId/ {entityID}"]:::step
    K --> L["NetReveal returns Alerts / Screening results"]:::step
    L --> M["Store screening results in Database"]:::step
    M --> N{"More entities to process?"}:::decision
    N -->|Yes| I
    N -->|No| endloop["End entity loop"]
  end

  H --> I
  endloop --> O{"Any True Hits found?"}:::decision

  O -->|No| Ppre["Convert JSON -> XML locally, Encrypt JSON"]:::step
  Ppre --> Pcall["CLM-Adaptor calls FenX API to close Validation Task (JourneyId)"]:::step
  Pcall --> Q["FenX closes Validation Task and returns 200 OK (Closed)"]:::step
  Q --> R["CLM-Adaptor records closure"]:::step

  O -->|Yes| S["Keep Validation Task open for manual review"]:::step
end
style MainFlow stroke-dasharray: 5 5

%% Decision between main and error blocks
IfError{"if error?"}:::decision

%% Error handling block to the right
subgraph ErrorHandler [Error handling]
  direction TB
  EH1["Log Error to Error table"]:::step
  EH2["Call Receptor API with Error details"]:::step
  EH1 --> EH2
end

style ErrorHandler fill:#ffe6e6,stroke:#ff0000,stroke-dasharray: 5 5

%% Connections: only between blocks (not individual nodes)
MainFlow -.-> IfError
IfError -.-> ErrorHandler
class A,B,C,D,E,F,G,H,Gpre,Gcall,J,K,L,M,Ppre,Pcall,Q,R,S,T step
class O,N decision
class I loop
 
Comments ~~~MainFlow