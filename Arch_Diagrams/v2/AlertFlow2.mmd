%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart LR
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

subgraph Comments [Comments / Legend]
  direction LR
  style Comments fill:#f9fafb,stroke:#e5e7eb,color:#0f172a,stroke-width:1px;
  note1["This flow is for processing journey alerts already fetched and stored in the database, but could not be processed due to Journey stage not at Screening Stage during the previous check"]:::footer
end

%% Pending Alerts Flow
subgraph MainFlow ["Process Pending Journey Alerts"]
	direction TB 
	A1["Timer Trigger every X minutes"]:::step
	A1 --> A2["Query ScreeningHitDetails Database Table where {AlertStatus = 'Closed'} and {AlertProcessingStatus = Null} - Open Alerts Only"]:::step
	A2 --> AlertCheckCondition["Get all Alert BatchId where Alert Hit Count grouped by BatchId (from ScreeningHitDetails Table) â‰¥ Alert Details count Grouped by BatchID (from ScreeningHit Table)"]:::step
	%% A3 -->AlertCheckCondition["Check Alert Hit Count grouped by BatchId == Alert Details count Grouped by BatchID"]:::step
	AlertCheckCondition -->|Yes| A4["Get All BatchIds , JourneyId that fulfill condition"]:::step 
	A4 --> UpdateAlerts["Update ScreeningHitDetails Table set {AlertProcessingStatus=Processing} for Retrieved Closed Alerts by BatchId"]:::step
		
	UpdateAlerts --> LoopStart(("Loop: Array - Only Closed {alerts} and All Alerts For a BatchId")):::loop
	%%A2 --> LoopStart((Loop: Pending Alerts)):::loop

	subgraph PendingLoop [Pending Alerts Grouped by BatchId]
		direction TB
		LoopStart --> E2["Query FenX for Journey Info /api/journey-instance/{journeyInstanceId}"]:::step
		E2 --> M{"FenX Journey Open?"}:::decision
		M -->|No| N0["Query ScreeningHitDetails Database Table to Get Alerts by JourneyId, BatchId"]:::step
		M -->|Yes| I["Set {AlertProcessingStatus = Null} in ScreeningHitDetails Table  "]:::step
		I --> LoopStart
		N0 --> N1["Update Journey by calling FenX Receptor API Grouped By BatchId /api/receptor"]:::step
		N1 --> N2["Update {AlertProcessingStatus=Processed} and continue"]:::step
		N2 --> N3["Mark Pending Alert Closed in DB"]:::step
		N3 --> LoopStart
	end
	PendingLoop --> BottomAnchor((" "))
	BottomAnchor --> O["End Alerts Processing"]:::footer
	class BottomAnchor footer
end
style MainFlow stroke-dasharray: 5 5

%% Decision between main and error blocks
IfError{"if error?"}:::decision

%% Error handling block to the right
subgraph ErrorHandler ["Error handling"]
  direction TB
  EH1["Log Error to Error table"]:::step
  EH2["Set {AlertProcessingStatus} = Null for BatchIds Not Processed in ScreeningHitDetails Table"]:::step
  EH3["Call Receptor API with Error details"]:::step
  
  EH1 --> EH2 --> EH3
end

style ErrorHandler fill:#ffe6e6,stroke:#ff0000,stroke-dasharray: 5 5
MainFlow -.-> IfError
IfError -.-> ErrorHandler
Comments ~~~MainFlow