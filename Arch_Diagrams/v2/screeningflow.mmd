%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"9"}}}%%
flowchart LR

%% Shared styles (matching AlertsFlow)
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

subgraph MainFlow [Main Flow]
  direction TB
  A[Receive HTTP input with JourneyID, EntityID, Related Entities]:::step --> B[Respond HTTP Status 200 immediately]:::step
  B --> C[Decrypt payload using Azure Key Vault keys. Payload contains #123;allEntities#125;]:::step
  C --> D[Store Request payload in database]:::step
  D --> FenX[Call FenX Association Query API with Entity ID and Journey<br/>  /api/association/root/#123;EntityId#125;/journey/#123;JourneyId#125;/proposedChanges/hierarchy API and get the array of deleted Entities : Return #123;deletedEntities#125;]:::step
  FenX --> DBSaveAssociation[Save FenX Association Request / Response to Database]:::step
  DBSaveAssociation --> LoopStart((Loop: Entities #123;allEntities#125;)):::loop

  subgraph EntitiesLoop ["Loop  Entities {allEntities}  ( All Entities for Journey  )"]
    direction TB
    LoopStart -->  F{If Current Entity of #123;allEntities#125; is in #123;deletedEntities#125;}:::decision
    G[Query Association API associationquery/api/association/root/#123;entityId#125; with current #123;entityId#125; to find Related EntityIDs]:::step
    F -- Yes --> G
    F -- No --> L[Get OrgUnit from Azure SQL DB - Branch and Department mapping]:::step
    G --> DBSaveAssociationEntity[Save Entity Association Request Response to Database]:::step
    DBSaveAssociationEntity --> H{Check Related Entities: Check Array Size of of assosication query}:::decision
    H -- No --> Inactive[Mark Entities with Empty Related Entities as InActive]:::step
    H -- Yes --> Active[Mark Entities with Related Entities Array Count >= 1 as Active]:::step
    Inactive --> L
    Active --> L
    L --> CallEntity[Call FenX API to get Full Entity Details]:::step
    CallEntity --> M[Save Full Entity Details to Database with OrgUnit Mapping and Active/Inactive status]:::step
    M --> N[Prepare to call NetReveal - Convert To XML Format]:::step
    N -->  NRCall[Call NetReveal Screening API for entity i]:::step
    NRCall --> SaveToDB[Save NetReveal AlertId against each entity]:::step
    SaveToDB --> Q{More entities to process?}:::decision
    Q -- Yes --> LoopStart
    Q -- No --> Done[Exit For Each Entity Loop]:::step
  end

  Done --> P[End process - No response sent back to FenX]:::footer
end

style MainFlow stroke-dasharray: 5 5

%% Decision between main and error blocks
IfError{if error?}:::decision

%% Error handling block to the right
subgraph ErrorHandler [Error handling]
  direction TB
  EH1[Log Error to Error table]:::step
  EH2[Call Receptor API with Error details]:::step
  EH1 --> EH2
end

style ErrorHandler fill:#ffe6e6,stroke:#ff0000,stroke-dasharray: 5 5

%% Connections: only between blocks (not individual nodes)
MainFlow -.-> IfError
IfError -.-> ErrorHandler