%%{init: {"theme":"default","themeVariables": {"fontSize":"12"}}}%%
sequenceDiagram
  %% Participants left-to-right for readability
  participant iHubIn as "iHub API Mgmt (FenX)"
  participant FenX as "FenX (Source API / SuperGraph)"
  participant CLMAdaptor as "CLM-Adaptor"
  participant DB as "Database"
  participant iHubOut as "iHub API Mgmt (NetReveal)"
  participant NetReveal

  %% Timer Trigger
  Note over CLMAdaptor: Timer Trigger every X minutes
  
  %% Get last successful run time
  CLMAdaptor->>+DB: Get {CompletedOn} from JourneyAlertJob table (Last successful run time)
  DB-->>-CLMAdaptor: Return {CompletedOn}
  
  %% Call NetReveal TrueHit API
  Note over CLMAdaptor: Prepare request for NetReveal TrueHit API
  CLMAdaptor->>CLMAdaptor: Convert request JSON -> XML format
  CLMAdaptor->>+iHubOut: Call NetReveal TrueHit API for Alerts since {CompletedOn} (XML)
  iHubOut->>+NetReveal: Forward TrueHit API request (XML)
  NetReveal-->>-iHubOut: Return Array[{alerts}] (XML)
  iHubOut-->>-CLMAdaptor: Return Array[{alerts}] (XML)
  CLMAdaptor->>CLMAdaptor: Convert response XML -> JSON format
  
  %% Insert new job record
  CLMAdaptor->>+DB: Insert new record into JourneyAlertJob Table with {StartedOn}=Current Datetime, {BatchProcessingStatus}='Processing'
  DB-->>-CLMAdaptor: Return {JourneyAlertJobId}
  
  %% Store alerts in database
  CLMAdaptor->>+DB: Store All Retrieved Alerts into ScreeningHitDetails Table
  DB-->>-CLMAdaptor: Stored
  
  %% Database checks and updates (can be in a single Stored Procedure)
  rect rgb(240, 249, 255)
    Note over CLMAdaptor,DB: All Checks and Updates in DB
    CLMAdaptor->>+DB: Retrieve Only Closed Alerts where AlertStatus='Closed' and AlertProcessingStatus=Null
    DB-->>-DB: Return Closed Alerts
    
    DB->>+DB: Get all Alert BatchId where Alert Hit Count grouped by BatchId (from ScreeningHitDetails) â‰¥ Alert Details count Grouped by BatchID (from ScreeningHit)
    DB-->>-DB: Return validation result
    
    DB->>+DB: Update ScreeningHitDetails set AlertProcessingStatus='Processing' for Retrieved Closed Alerts by BatchId that meet condition
    DB-->>-CLMAdaptor: Return Alerts Grouped by BatchId that need processing
  end
  
  %% Loop through closed alerts grouped by BatchId
  loop For Each BatchId with Only Closed Alerts
    
    %% Query FenX for Journey Info
    CLMAdaptor->>+iHubIn: Call FenX Journey API to get Journey using SuperGraph (JSON)
    iHubIn->>+FenX: Forward Journey API request (JSON)
    FenX-->>-iHubIn: Return Journey Info (JSON)
    iHubIn-->>-CLMAdaptor: Return Journey Info (JSON)
    
    %% Decision: Journey Open?
    alt Journey is Open
      
      alt Journey at Screening Stage
        Note over CLMAdaptor: Journey is Open and at Screening Stage
        
        %% Update Journey via Receptor API
        CLMAdaptor->>+iHubIn: Call FenX Receptor API - Update Journey Grouped by BatchId (JSON)
        iHubIn->>+FenX: Forward Receptor API request (JSON)
        FenX-->>-iHubIn: Return success (JSON)
        iHubIn-->>-CLMAdaptor: Return success (JSON)
        
        %% Update processing flag
        CLMAdaptor->>+DB: Update ScreeningHitDetails set AlertProcessingStatus='Processed' against {BatchId}
        DB-->>-CLMAdaptor: Updated
        
        CLMAdaptor->>+DB: Insert into JourneyAlertJobRunDetails ({BatchId}, {BatchProcessingStatus}, {JourneyAlertJobId})
        DB-->>-CLMAdaptor: Inserted
        
      else Journey not at Screening Stage
        Note over CLMAdaptor: Journey is Open but not at Screening Stage
        CLMAdaptor->>+DB: Set AlertProcessingStatus=Null for current {BatchId} and {JourneyId} in ScreeningHitDetails Table
        DB-->>-CLMAdaptor: Updated
      end
      
    else Journey is Closed
      Note over CLMAdaptor: Mark the Journey as Ongoing Screening
      
      %% Update Journey via Receptor API
      CLMAdaptor->>+iHubIn: Call FenX Receptor API - Update Journey Grouped by BatchId (JSON)
      iHubIn->>+FenX: Forward Receptor API request (JSON)
      FenX-->>-iHubIn: Return success (JSON)
      iHubIn-->>-CLMAdaptor: Return success (JSON)
      
      %% Update processing flag
      CLMAdaptor->>+DB: Update ScreeningHitDetails set AlertProcessingStatus='Processed' for all Alerts in current {BatchId}, {JourneyId}
      DB-->>-CLMAdaptor: Updated
      
      CLMAdaptor->>+DB: Insert into JourneyAlertJobRunDetails ({BatchId}, {BatchProcessingStatus}, {JourneyAlertJobId})
      DB-->>-CLMAdaptor: Inserted
      
      CLMAdaptor->>+CLMAdaptor: Maintain list of successfully processed {JourneyIds}, {BatchIds} for rollback in case of error
      
    end
    
    Note over CLMAdaptor: Pick Next Batch Alert
    
  end
  
  Note over CLMAdaptor: End Alerts Processing - Update last successful run time
  CLMAdaptor->>+DB: Update Datetime of Last Successful Run in JourneyAlertJob Table
  DB-->>-CLMAdaptor: Updated

  %% Error handling
  alt Error Occurs
    CLMAdaptor->>+DB: Log Error to Error table
    DB-->>-CLMAdaptor: Logged
    
    CLMAdaptor->>+DB: Set AlertProcessingStatus=Null for BatchIds Not Processed in ScreeningHitDetails Table
    DB-->>-CLMAdaptor: Updated
    
    CLMAdaptor->>+iHubIn: Call Receptor API with Error details (JSON)
    iHubIn->>+FenX: Forward error to Receptor API (JSON)
    FenX-->>-iHubIn: Acknowledged (JSON)
    iHubIn-->>-CLMAdaptor: Error reported
  end