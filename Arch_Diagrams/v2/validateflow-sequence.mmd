%%{init: {"theme":"default","themeVariables": {"fontSize":"12"}}}%%
sequenceDiagram
  %% Participants left-to-right for readability
  participant Client
  participant iHubIn as "iHub API Mgmt (FenX)"
  participant FenX as "FenX"
  participant CLMAdaptor as "CLM-Adaptor"
  participant DB as "Database"
  participant iHubOut as "iHub API Mgmt (NetReveal)"
  participant NetReveal

  %% Initial request (no encryption)
  Client->>+iHubIn: User clicks 'Validate Task' on Main Screening Flow
  iHubIn->>+CLMAdaptor: HTTP POST with JourneyID only (JSON)
  CLMAdaptor-->>-iHubIn: HTTP 200 OK (immediate response)
  iHubIn-->>-Client: Response acknowledged
  
  %% Store request
  CLMAdaptor->>+DB: Store Request payload
  DB-->>-CLMAdaptor: Stored
  
  %% Call FenX SuperGraph API to get Current/Draft Entities
  Note over CLMAdaptor: Call SuperGraph to get Entities involved including RP (Current/Draft Entity Data)
  CLMAdaptor->>+iHubIn: Call FenX SuperGraph API with JourneyId
  iHubIn->>+FenX: Forward SuperGraph request
  FenX-->>-iHubIn: Return {allEntities} (EntityIDs & RelatedParties)
  iHubIn-->>-CLMAdaptor: Return {allEntities}
  CLMAdaptor->>+DB: Save SuperGraph Request / Response
  DB-->>-CLMAdaptor: Saved
  
  %% Loop through all entities
  loop For Each Entity in {allEntities}
    
    %% Prepare to call NetReveal - Convert JSON to XML
    Note over CLMAdaptor: Convert JSON to XML locally for entity payload
    CLMAdaptor->>CLMAdaptor: Convert JSON to XML
    
    %% Call NetReveal API
    CLMAdaptor->>+iHubOut: Call NetReveal API (XML) using CustomerId/{entityId}
    iHubOut->>+NetReveal: Forward request (XML)
    NetReveal-->>-iHubOut: Return Alerts / Screening results (XML)
    iHubOut-->>-CLMAdaptor: Return Alerts / Screening results (XML)
    
    %% Save NetReveal response
    CLMAdaptor->>+DB: Store screening results in Database
    DB-->>-CLMAdaptor: Saved
    
  end
  
  %% Check for True Hits
  CLMAdaptor->>CLMAdaptor: Analyze screening results for True Hits
  
  alt No True Hits Found
    Note over CLMAdaptor: No True Hits - Close Validation Task
    CLMAdaptor->>CLMAdaptor: Convert JSON -> XML locally, Encrypt JSON
    CLMAdaptor->>+iHubIn: Call FenX API to close Validation Task: /api/journey-instance/{journeyInstanceId}/task/complete
    iHubIn->>+FenX: Forward task completion request
    FenX-->>-iHubIn: Return 200 OK (Validation Task Closed)
    iHubIn-->>-CLMAdaptor: Validation Task Closed
    CLMAdaptor->>+DB: Record task closure
    DB-->>-CLMAdaptor: Recorded
    Note over CLMAdaptor: End process - Validation Task closed successfully
  else True Hits Found
    Note over CLMAdaptor: True Hits detected - Keep Validation Task open for manual review
    CLMAdaptor->>+DB: Record that manual review is required
    DB-->>-CLMAdaptor: Recorded
    Note over CLMAdaptor: End process - Validation Task remains open
  end

alt Error Occurs
    CLMAdaptor->>+DB: Log Error to Error table
    DB-->>-CLMAdaptor: Logged
    CLMAdaptor->>+iHubIn: Call Receptor API with Error details
    iHubIn->>+FenX: Forward error to Receptor API
    FenX-->>-iHubIn: Acknowledged
    iHubIn-->>-CLMAdaptor: Error reported
end
