%%{init: {"theme":"default","themeVariables": {"fontSize":"12"}}}%%
sequenceDiagram
  %% Participants left-to-right for readability
  participant Client
  participant iHubIn as "iHub API Mgmt (FenX)"
  participant FenX as "FenX"
  participant CLMAdaptor as "CLM-Adaptor"
  participant DB as "Database"
  participant iHubOut as "iHub API Mgmt (NetReveal)"
  participant NetReveal

  %% Initial request (no encryption)
  Client->>+iHubIn: User clicks 'Validate Task' on Main Screening Flow
  iHubIn->>+CLMAdaptor: HTTP POST with JourneyID only (JSON)
  CLMAdaptor-->>-iHubIn: HTTP 200 OK (immediate response)
  iHubIn-->>-Client: Response acknowledged
  
  %% Store request
  CLMAdaptor->>+DB: Store Request payload in RequestResponsePayload Table
  DB-->>-CLMAdaptor: Stored
  
  %% Call FenX SuperGraph API to get Current/Draft Entities
  Note over CLMAdaptor: Call SuperGraph to get Entities involved including RP (Current/Draft Entity Data)
  CLMAdaptor->>+iHubIn: Call FenX SuperGraph API with JourneyId (JSON)
  iHubIn->>+FenX: Forward SuperGraph request (JSON)
  FenX-->>-iHubIn: Return array[{allEntities}] with {entityId}, {entityDraftId} (JSON)
  iHubIn-->>-CLMAdaptor: Return array[{allEntities}]
  CLMAdaptor->>+DB: Save SuperGraph Request / Response to RequestResponsePayload Table
  DB-->>-CLMAdaptor: Saved
  
  %% Loop through all entities
  loop For Each Entity in {allEntities}
    
    %% Prepare to call NetReveal - Convert JSON to XML
    Note over CLMAdaptor: Convert JSON to XML locally for entity payload
    CLMAdaptor->>CLMAdaptor: Convert JSON to XML
    
    %% Call NetReveal API
    CLMAdaptor->>+iHubOut: Call NetReveal API (XML) using {entityID},{requestId}
    iHubOut->>+NetReveal: Forward request (XML)
    NetReveal-->>-iHubOut: Return OpenWLMActiveAlerts (XML)
    iHubOut-->>-CLMAdaptor: Return OpenWLMActiveAlerts (XML)
    
    %% Save NetReveal response
    CLMAdaptor->>+DB: Store screening results in RequestResponsePayload Table
    DB-->>-CLMAdaptor: Saved
    
    %% Check for True Hits per entity
    CLMAdaptor->>CLMAdaptor: Check if any True Hits found in OpenWLMActiveAlerts
    
    alt True Hits Found for this Entity
      Note over CLMAdaptor: True Hit detected - Update Draft Entity
      CLMAdaptor->>+iHubIn: Call FenX API /api/v3/{entityId}/draft/{id} - Update Draft Entity with {entityId}, {entityDraftId} and Alert Flag (JSON)
      iHubIn->>+FenX: Forward Draft Entity update request (JSON)
      FenX-->>-iHubIn: Return success (JSON)
      iHubIn-->>-CLMAdaptor: Draft Entity updated
    else No True Hits for this Entity
      Note over CLMAdaptor: No True Hits - Increment counter
      CLMAdaptor->>CLMAdaptor: Increment No True Hits counter
    end
    
  end
  
  %% Check aggregate True Hits count
  Note over CLMAdaptor: Evaluate: Count of No True Hits >= {entityTotalCount}
  
  alt No True Hits Found (Count of No True Hits >= {entityTotalCount})
    Note over CLMAdaptor: No True Hits - Close Validation Task

    CLMAdaptor->>+iHubIn: Call FenX API to close Validation Task: /api/journey-instance/{journeyInstanceId}/task/complete (JSON)
    iHubIn->>+FenX: Forward task completion request (JSON)
    FenX-->>-iHubIn: Return 200 OK (Validation Task Closed)
    iHubIn-->>-CLMAdaptor: Validation Task Closed
    CLMAdaptor->>+DB: Record task closure in RequestResponsePayload Table
    DB-->>-CLMAdaptor: Recorded
    Note over CLMAdaptor: End process - Validation Task closed successfully
  
  end

alt Error Occurs
    CLMAdaptor->>+CLMAdaptor: Log Error to Azure Application Insight Error Logs
     
end
