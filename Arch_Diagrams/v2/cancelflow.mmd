%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart TB

%% Shared styles (matching AlertsFlow)
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

A[Receive HTTP POST due to Cancel Event via Hub API Gateway]:::step --> B[Respond HTTP Status 200 immediately]:::step
B --> C[Decrypt payload using Azure Key Vault keys]:::step
C --> D[Store payload in database]:::step
D --> E[Create SuperGraph using GraphQL with RequestId, JourneyId]:::step
E --> FenX[Call FenX to Fetch <b>Verified Entity/Related Entities</b> ]:::step
FenX --> LoopStart((Loop: Entities)):::loop

subgraph EntitiesLoop [Loop through Entities]
  direction TB
  LoopStart --> XMLConvert[Convert SuperGraph JSON to XML with Liquid Templates]:::step
  XMLConvert --> N[Call NetReveal Screening API for entity i]:::step
  N --> Q{More entities to process?}:::decision
  Q -- Yes --> LoopStart
  Q -- No --> O[Store after all NetReveal calls succeed]:::step
end

O --> P[End process - No response sent back to FenX]:::footer
