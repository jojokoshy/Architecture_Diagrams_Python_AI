
%%{init: {"theme":"default","themeVariables": {"background":"#ffffff","fontSize":"14"}}}%%
flowchart TB

%% Shared styles
classDef step fill:#ffffff,stroke:#2b6cb0,color:#0f172a,stroke-width:1px;
classDef decision fill:#fff7ed,stroke:#d97706,color:#92400e,stroke-width:1px;
classDef loop fill:#f0f9ff,stroke:#60a5fa,color:#0f172a,stroke-width:1px;
classDef footer fill:#ffffff,stroke:none,color:#0f172a;

%% Main Flow

A[Receive HTTP Request as input due to event raised by FenX]:::step --> B[Get details about the journey from FenX like EntityID and Related EntityIDs]:::step
B --> AlertsLoopStart((Loop: Entity/RP Array)):::loop

%% loop entry (Call moved into loop)

subgraph AlertsLoop [Loop through Entity/RP Array]
	direction TB
	AlertsLoopStart --> C[Call NetReveal --Customer Get Alerts API-- with CustomerID, JourneyStartDateTime , EndDateTime]:::step
	C --> D{Alert Status?}:::decision
	D -->|Confirmed/Disapproved| E[Save the Alert Details to Database]:::step
	D -->|Reopened| AlertsLoopStart
end

%% After completing loop over Entity/RP Array, process batches
AlertsLoop --> F1[Read from all unprocessed alerts Filter By  EntityID where ScreeningAlertDetails rowcount => ScreeningAlert rowcount by BatchId]:::step

F1 --> J1[Group all Alerts from ScreeningAlertDetails by BatchId ]:::step

J1 --> BatchLoopStart((Loop: For every BatchId)):::loop

subgraph BatchLoop [Loop: For every Unique BatchId  ]
	direction TB
	BatchLoopStart --> J2[ Submit to Receptor API all Alerts with same BatchId with Flag indicating Screening Type]:::step
	J2 --> BatchLoopStart
end

BatchLoop --> BottomAnchor(( ))

%% Legend
subgraph Legend [Legend]
	direction LR
	L2[Decision]:::decision
	L3[Loop]:::loop	
end

BottomAnchor --> N[Change flag of all AlertsIds that were successfully send to FenX]:::step
N --> O[Update JourneyAlert table: Job Success]:::footer
class BottomAnchor footer
